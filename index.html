<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>College Help Desk</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f9f9f9;
      color: #333;
    }
    header {
      background-color: #004080;
      color: rgb(235, 235, 235);
      padding: 20px;
      text-align: center;
      position: relative;
    }
    nav {
      background: #0066cc;
      display: flex;
      justify-content: center;
      gap: 30px;
      padding: 10px;
      flex-wrap: wrap;
    }
    nav a {
      color: white;
      text-decoration: none;
      font-weight: bold;
    }
    nav a:hover { text-decoration: underline; }
    .hero {
      background: url('https://source.unsplash.com/featured/?college,campus') no-repeat center center/cover;
      height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #004080;
      text-shadow: 1px 1px 3px #000;
    }
    .hero h1 { font-size: 3rem; }
    section {
      padding: 40px 20px;
      max-width: 900px;
      margin: auto;
    }
    .section-title {
      font-size: 2rem;
      margin-bottom: 20px;
      color: #004080;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    footer {
      background: #004080;
      color: white;
      text-align: center;
      padding: 20px;
    }
    .chatbot-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #0066cc;
      color: white;
      padding: 12px 18px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    #loginModal, #registerModal, #chatbotModal, #docRequestModal, #ticketModal, #profileModal, #adminModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    #loginModal > div, #registerModal > div, #chatbotModal > div, #docRequestModal > div, #ticketModal > div, #profileModal > div, #adminModal > div {
      display: flex;
      flex-direction: column;
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .success-message {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
    }
    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
    }
    #chatLog {
      height: 300px;
      overflow-y: auto;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 5px;
    }
    .chat-message {
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 5px;
      max-width: 80%;
    }
    .user-message {
      background: #e3f2fd;
      margin-left: auto;
      text-align: right;
    }
    .bot-message {
      background: #f1f1f1;
      margin-right: auto;
    }
    .typing {
      display: inline-block;
      width: 10px;
      height: 10px;
      background: #0066cc;
      border-radius: 50%;
      margin-left: 5px;
      animation: typing 1s infinite;
    }
    @keyframes typing {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }
    .timestamp {
      font-size: 0.8em;
      color: #666;
      margin-top: 2px;
    }
    .department-select {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
    }
    #voiceBtn {
      background: #004080;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      margin-left: 5px;
    }
    #chatInputContainer {
      display: flex;
    }
    #chatInput {
      flex-grow: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    #chatSend {
      background: #004080;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      margin-left: 5px;
      cursor: pointer;
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #004080;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
    }
    @media (max-width: 600px) {
      nav { gap: 10px; }
      .hero h1 { font-size: 2rem; }
      #loginModal > div, #registerModal > div, #chatbotModal > div, #docRequestModal > div, #ticketModal > div, #profileModal > div, #adminModal > div {
        width: 95%;
      }
    }
    a {
      color: #000000;
      text-decoration: none;
    }
  </style>
</head>
<body>

<header>
  <img src="Collegehelpdesk.jpg" alt="College Help Desk Logo" style="height: 80px; vertical-align: middle; margin-right: 5px;">
  <h1 style="display: inline; vertical-align: middle;">College Help Desk</h1>
  <p>Your one-stop portal for college queries and assistance</p>
  <div style="position: absolute; top: 20px; right: 20px;">
    <button onclick="toggleProfileModal()" id="profileBtn" style="margin-right: 10px; background-color: white; color: #004080; font-weight: bold; border: none; padding: 8px 16px; border-radius: 5px; display: none;">Profile</button>
    <button onclick="toggleAdminModal()" id="adminBtn" style="margin-right: 10px; background-color: white; color: #004080; font-weight: bold; border: none; padding: 8px 16px; border-radius: 5px; display: none;">Admin</button>
    <button onclick="toggleLoginModal()" id="loginBtn" style="margin-right: 10px; background-color: white; color: #004080; font-weight: bold; border: none; padding: 8px 16px; border-radius: 5px;">Login</button>
    <button onclick="toggleRegisterModal()" id="registerBtn" style="background-color: white; color: #004080; font-weight: bold; border: none; padding: 8px 16px; border-radius: 5px;">Register</button>
    <button onclick="logout()" id="logoutBtn" style="background-color: white; color: #004080; font-weight: bold; border: none; padding: 8px 16px; border-radius: 5px; display: none;">Logout</button>
  </div>
</header>

<nav>
  <a href="#about">About</a>
  <a href="#topics">Help Topics</a>
  <a href="#faq">FAQs</a>
  <a href="#documents">Documents</a>
  <a href="#contact">Contact</a>
  <a href="feedback.html">Feedback</a>
  <a href="documentation.html">Documentation</a>
</nav>

<div class="hero">
  <h1>Welcome to Our Help Desk</h1>
</div>

<section id="about">
  <h2 class="section-title">About Us</h2>
  <div class="card">
    <p>
      The College Help Desk is here to assist students with admission queries, fee-related questions, course info, and much more. Our AI chatbot and support team ensure fast and accurate responses.
    </p>
  </div>
</section>

<section id="topics">
  <h2 class="section-title">Help Topics</h2>
  <div class="card">
    <ul>
      <li>üìö Admission Process</li>
      <li>üí∏ Fee Payment and Scholarships</li>
      <li>üèõÔ∏è Campus Facilities</li>
      <li>üßë‚Äçüè´ Faculty and Courses</li>
      <li>üìÖ Academic Calendar</li>
    </ul>
  </div>
</section>

<section id="faq">
  <h2 class="section-title">FAQs</h2>
  <div class="card" id="faqList"></div>
</section>

<section id="documents">
  <h2 class="section-title">Documents</h2>
  <div class="card">
    <div style="margin-top: 15px;">
      <h3>Available Documents</h3>
      <ul>
        <li><a href="bonafide.pdf" onclick="downloadDoc('bonafide')">Bonafide Certificate</a></li>
        <li><a href="transfer.pdf" onclick="downloadDoc('transfer')">Transfer Certificate</a></li>
      </ul>
    </div>
  </div>
</section>

<section id="tickets">
  <h2 class="section-title">Raise a Ticket</h2>
  <div class="card">
    <p>If you have an issue that needs attention, please raise a ticket.</p>
    <button onclick="toggleTicketModal()" style="background-color: #004080; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer;">Raise Ticket</button>
  </div>
</section>

<section id="contact">
  <h2 class="section-title">Contact Us</h2>
  <div class="card">
    <p>Email: support@college.edu</p>
    <p>Phone: +91-9876543210</p>
    <p>Office Hours: Mon - Fri, 9 AM - 5 PM</p>
  </div>
</section>

<footer>
  &copy; 2025 College Help Desk. All Rights Reserved.
</footer>

<!-- Login Modal -->
<div id="loginModal">
  <div>
    <h2 style="margin-bottom:15px; color:#004080;">Login</h2>
    <div id="loginSuccess" class="success-message" style="display:none;">Successfully logged in</div>
    <div id="loginMessage" class="success-message" style="display:none;">Your profile is created successfully, you can now login</div>
    <div id="loginError" class="error-message" style="display:none;">Invalid! Please register first.</div>
    <input type="email" placeholder="Email" id="loginEmail" style="width:100%; padding:8px; margin-bottom:10px;" />
    <input type="password" placeholder="Password" id="loginPassword" style="width:100%; padding:8px; margin-bottom:10px;" />
    <button onclick="submitLogin()" style="width:100%; background-color:#004080; color:white; padding:10px; border:none; border-radius:5px;">Login</button>
    <button onclick="toggleLoginModal()" style="width:100%; margin-top:10px; background:none; color:#004080; border:none;">Cancel</button>
  </div>
</div>

<!-- Register Modal -->
<div id="registerModal">
  <div>
    <h2 style="margin-bottom:15px; color:#004080;">Register</h2>
    <div id="registerSuccess" class="success-message" style="display:none;">Successfully registered</div>
    <input type="text" placeholder="Full Name" id="regName" style="width:100%; padding:8px; margin-bottom:10px;" />
    <input type="email" placeholder="Email" id="regEmail" style="width:100%; padding:8px; margin-bottom:10px;" />
    <input type="password" placeholder="Password" id="regPassword" style="width:100%; padding:8px; margin-bottom:10px;" />
    <button onclick="submitRegister()" style="width:100%; background-color:#004080; color:white; padding:10px; border:none; border-radius:5px;">Register</button>
    <button onclick="toggleRegisterModal()" style="width:100%; margin-top:10px; background:none; color:#004080; border:none;">Cancel</button>
  </div>
</div>

<!-- Chatbot Modal -->
<div id="chatbotModal">
  <div>
    <h2 style="margin-bottom:15px; color:#004080;">Help Desk Chatbot</h2>
    <select id="departmentSelect" class="department-select">
      <option value="">Select Department</option>
      <option value="Admission">Admission</option>
      <option value="Fees">Fees</option>
      <option value="Timetable">Timetable</option>
      <option value="Hostel">Hostel</option>
      <option value="Exam">Exam</option>
      <option value="Documents">Documents</option>
    </select>
    <div id="chatLog"></div>
    <div id="chatInputContainer">
      <input type="text" id="chatInput" placeholder="Type your question..." />
      <button id="chatSend" onclick="sendChatMessage()">Send</button>
      <button id="voiceBtn" onclick="startVoiceInput()">üé§</button>
    </div>
    <button onclick="toggleChatbotModal()" style="width:100%; margin-top:10px; background:none; color:#004080; border:none;">Close</button>
  </div>
</div>

<!-- Document Request Modal -->
<div id="docRequestModal">
  <div>
    <h2 style="margin-bottom:15px; color:#004080;">Request Document</h2>
    <select id="docType" style="width:100%; padding:8px; margin-bottom:10px;">
      <option value="bonafide">Bonafide Certificate</option>
      <option value="transfer">Transfer Certificate</option>
    </select>
    <textarea id="docReason" placeholder="Reason for request" style="width:100%; padding:8px; margin-bottom:10px; min-height:80px;"></textarea>
    <button onclick="submitDocRequest()" style="width:100%; background-color:#004080; color:white; padding:10px; border:none; border-radius:5px;">Submit Request</button>
    <button onclick="toggleDocRequestModal()" style="width:100%; margin-top:10px; background:none; color:#004080; border:none;">Cancel</button>
  </div>
</div>

<!-- Ticket Modal -->
<div id="ticketModal">
  <div>
    <h2 style="margin-bottom:15px; color:#004080;">Raise a Ticket</h2>
    <select id="ticketDepartment" style="width:100%; padding:8px; margin-bottom:10px;">
      <option value="">Select Department</option>
      <option value="Admission">Admission</option>
      <option value="Fees">Fees</option>
      <option value="Timetable">Timetable</option>
      <option value="Hostel">Hostel</option>
      <option value="Exam">Exam</option>
      <option value="Documents">Documents</option>
    </select>
    <textarea id="ticketMessage" placeholder="Describe your issue" style="width:100%; padding:8px; margin-bottom:10px; min-height:80px;"></textarea>
    <button onclick="submitTicket()" style="width:100%; background-color:#004080; color:white; padding:10px; border:none; border-radius:5px;">Submit Ticket</button>
    <button onclick="toggleTicketModal()" style="width:100%; margin-top:10px; background:none; color:#004080; border:none;">Cancel</button>
  </div>
</div>

<!-- Profile Modal -->
<div id="profileModal">
  <div>
    <h2 style="margin-bottom:15px; color:#004080;">Your Profile</h2>
    <div id="profileInfo"></div>
    <div id="notificationsList" style="margin-top:20px;">
      <h3>Notifications</h3>
      <div id="notifications"></div>
    </div>
    <button onclick="toggleProfileModal()" style="width:100%; margin-top:10px; background:none; color:#004080; border:none;">Close</button>
  </div>
</div>

<!-- Admin Modal -->
<div id="adminModal">
  <div>
    <h2 style="margin-bottom:15px; color:#004080;">Admin Dashboard</h2>
    <div id="adminTickets" style="margin-bottom:20px;">
      <h3>Unanswered Tickets</h3>
      <div id="ticketsList"></div>
    </div>
    <div id="adminUsers" style="margin-bottom:20px;">
      <h3>User Statistics</h3>
      <div id="usersList"></div>
    </div>
    <div id="adminFAQs" style="margin-bottom:20px;">
      <h3>Manage FAQs</h3>
      <input type="text" id="faqQuestion" placeholder="Question" style="width:100%; padding:8px; margin-bottom:10px;" />
      <input type="text" id="faqAnswer" placeholder="Answer" style="width:100%; padding:8px; margin-bottom:10px;" />
      <select id="faqDepartment" style="width:100%; padding:8px; margin-bottom:10px;">
        <option value="Admission">Admission</option>
        <option value="Fees">Fees</option>
        <option value="Timetable">Timetable</option>
        <option value="Hostel">Hostel</option>
        <option value="Exam">Exam</option>
        <option value="Documents">Documents</option>
      </select>
      <button onclick="addFAQ()" style="width:100%; background-color:#004080; color:white; padding:10px; border:none; border-radius:5px;">Add FAQ</button>
      <div id="faqAdminList" style="margin-top:10px;"></div>
    </div>
    <button onclick="toggleAdminModal()" style="width:100%; margin-top:10px; background:none; color:#004080; border:none;">Close</button>
  </div>
</div>

<!-- Chatbot Toggle -->
<a href="chatbot.html"><button class="chatbot-toggle">Ask Help Bot</button>

<!-- Notification -->
<div id="notification" class="notification">Notification</div>

<script>
// Data storage (simulated)
let registeredUsers = JSON.parse(localStorage.getItem('registeredUsers')) || {};
let currentUser = JSON.parse(localStorage.getItem('currentUsers')) || null;
let tickets = JSON.parse(localStorage.getItem('tickets')) || [];
let faqs = JSON.parse(localStorage.getItem('faqs')) || [
  { question: "How do I apply for admission?", answer: "Visit the Admissions portal and fill out the form.", department: "Admission" },
  { question: "What is the fee structure?", answer: "Check the Fees section or contact the admin.", department: "Fees" },
  { question: "How do I get a bonafide certificate?", answer: "Request it from the Documents section.", department: "Documents" }
];
let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
let docRequests = JSON.parse(localStorage.getItem('docRequests')) || [];

// Initialize
window.onload = function() {
  updateUI();
  renderFAQs();
  
  // Show registration modal if no users exist
  if (Object.keys(registeredUsers).length === 0 && !currentUser) {
    toggleRegisterModal();
  }
};

// UI Helpers
// Modify your updateUI function:
function updateUI() {
    if (currentUser) {
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('registerBtn').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'inline-block';
        document.getElementById('profileBtn').style.display = 'inline-block';
        
        // Explicit admin check
        if (currentUser.isAdmin === true || currentUser.isAdmin === 1) {
            document.getElementById('adminBtn').style.display = 'inline-block';
            console.log("Admin access granted");
        } else {
            document.getElementById('adminBtn').style.display = 'none';
        }
    } else {
        document.getElementById('loginBtn').style.display = 'inline-block';
        document.getElementById('registerBtn').style.display = 'inline-block';
        document.getElementById('logoutBtn').style.display = 'none';
        document.getElementById('profileBtn').style.display = 'none';
        document.getElementById('adminBtn').style.display = 'none';
    }
}

function renderFAQs() {
  const faqList = document.getElementById('faqList');
  faqList.innerHTML = '';
  faqs.forEach(faq => {
    const div = document.createElement('div');
    div.style.marginBottom = '10px';
    div.innerHTML = `<strong>${faq.question}</strong><br>${faq.answer} <small>(${faq.department})</small>`;
    faqList.appendChild(div);
  });
}

// Modal Toggles
function toggleModal(id) {
  const modal = document.getElementById(id);
  modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
}

function toggleLoginModal() { 
  document.getElementById('loginMessage').style.display = 'none';
  document.getElementById('loginError').style.display = 'none';
  document.getElementById('loginSuccess').style.display = 'none';
  toggleModal('loginModal'); 
}

function toggleRegisterModal() { 
  document.getElementById('registerSuccess').style.display = 'none';
  toggleModal('registerModal'); 
}

function toggleChatbotModal() { toggleModal('chatbotModal'); }
function toggleDocRequestModal() { toggleModal('docRequestModal'); }
function toggleTicketModal() { toggleModal('ticketModal'); }
function toggleProfileModal() { 
  showProfile();
  toggleModal('profileModal'); 
}
function toggleAdminModal() { 
  showAdminPanel();
  toggleModal('adminModal'); 
}

// Auth
function submitRegister() {
  const name = document.getElementById('regName').value;
  const email = document.getElementById('regEmail').value;
  const pass = document.getElementById('regPassword').value;

  if (name && email && pass) {
    registeredUsers[email] = { name, pass, isAdmin: email === 'admin@college.edu' };
    localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
    
    // Clear form
    document.getElementById('regName').value = '';
    document.getElementById('regEmail').value = '';
    document.getElementById('regPassword').value = '';
    
    // Show success and switch to login
    document.getElementById('registerSuccess').style.display = 'block';
    setTimeout(() => {
      toggleRegisterModal();
      toggleLoginModal();
      document.getElementById('loginMessage').style.display = 'block';
    }, 1000);
  }
}

function submitLogin() {
  const email = document.getElementById('loginEmail').value;
  const pass = document.getElementById('loginPassword').value;

  document.getElementById('loginMessage').style.display = 'none';
  document.getElementById('loginError').style.display = 'none';

  if (registeredUsers[email] && registeredUsers[email].pass === pass) {
    currentUser = { email, name: registeredUsers[email].name, isAdmin: registeredUsers[email].isAdmin };
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    
    // Clear form
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
    
    // Show success and close modal
    document.getElementById('loginSuccess').style.display = 'block';
    setTimeout(() => {
      toggleLoginModal();
      updateUI();
    }, 1000);
  } else {
    document.getElementById('loginError').style.display = 'block';
  }
}

function logout() {
  currentUser = null;
  localStorage.setItem('currentUser', JSON.stringify(currentUser));
  updateUI();
  showNotification("Logged out successfully");
}

// Chatbot
function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  if (!message) return;

  const department = document.getElementById('departmentSelect').value;
  addChatMessage(message, 'user', department);

  // Simulate typing
  const typing = document.createElement('span');
  typing.className = 'typing';
  document.getElementById('chatLog').appendChild(typing);
  setTimeout(() => {
    document.getElementById('chatLog').removeChild(typing);
    const answer = getChatAnswer(message, department);
    addChatMessage(answer, 'bot', department);
    // Auto-scroll
    document.getElementById('chatLog').scrollTop = document.getElementById('chatLog').scrollHeight;
    // Save chat history
    chatHistory.push({ user: currentUser?.email || 'guest', message, answer, department, timestamp: new Date().toISOString() });
    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
    // Ask for feedback
    setTimeout(() => {
      addChatMessage("Was this answer helpful? (Yes/No)", 'bot', department);
    }, 1000);
  }, 1500);
  input.value = '';
}

function addChatMessage(text, sender, department) {
  const chatLog = document.getElementById('chatLog');
  const msg = document.createElement('div');
  msg.className = `chat-message ${sender}-message`;
  const time = new Date().toLocaleTimeString();
  msg.innerHTML = `<div>${text}</div><div class="timestamp">${time}${department ? ' ‚Ä¢ ' + department : ''}</div>`;
  chatLog.appendChild(msg);
  chatLog.scrollTop = chatLog.scrollHeight;
}

function getChatAnswer(question, department) {
  // Simple keyword matching (for demo)
  const q = question.toLowerCase();
  const dept = department || '';
  let answer = "I couldn't find an answer. Would you like to raise a ticket for this question?";
  for (const faq of faqs) {
    if (q.includes(faq.question.toLowerCase().split(' ')[0]) && (!dept || faq.department === dept)) {
      answer = faq.answer;
      break;
    }
  }
  return answer;
}

// Voice input (simulated)
function startVoiceInput() {
  if ('webkitSpeechRecognition' in window) {
    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'en-US';
    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript;
      document.getElementById('chatInput').value = transcript;
    };
    recognition.start();
  } else {
    showNotification('Voice input not supported in this browser.');
  }
}

// Documents
function downloadDoc(type) {
  showNotification(`Downloading ${type} certificate...`);
  // Simulate download
}

function submitDocRequest() {
  const type = document.getElementById('docType').value;
  const reason = document.getElementById('docReason').value;
  if (!reason) return;
  docRequests.push({ user: currentUser?.email || 'guest', type, reason, timestamp: new Date().toISOString() });
  localStorage.setItem('docRequests', JSON.stringify(docRequests));
  showNotification('Document request submitted.');
  toggleDocRequestModal();
}

// Tickets
function submitTicket() {
  const department = document.getElementById('ticketDepartment').value;
  const message = document.getElementById('ticketMessage').value;
  if (!department || !message) return;
  tickets.push({ user: currentUser?.email || 'guest', department, message, status: 'open', timestamp: new Date().toISOString() });
  localStorage.setItem('tickets', JSON.stringify(tickets));
  showNotification('Ticket submitted. We will get back to you soon.');
  toggleTicketModal();
}

// Profile
function showProfile() {
  const profileInfo = document.getElementById('profileInfo');
  const notificationsDiv = document.getElementById('notifications');
  profileInfo.innerHTML = currentUser ? `<p><strong>Name:</strong> ${currentUser.name}</p><p><strong>Email:</strong> ${currentUser.email}</p>` : 'Not logged in';
  notificationsDiv.innerHTML = '';
  notifications.filter(n => n.user === currentUser?.email).forEach(n => {
    const div = document.createElement('div');
    div.style.marginBottom = '10px';
    div.innerHTML = `<strong>${n.title}</strong><br>${n.message} <small>${new Date(n.timestamp).toLocaleString()}</small>`;
    notificationsDiv.appendChild(div);
  });
}

// Admin
function showAdminPanel() {
  const ticketsList = document.getElementById('ticketsList');
  const usersList = document.getElementById('usersList');
  const faqAdminList = document.getElementById('faqAdminList');
  ticketsList.innerHTML = '';
  usersList.innerHTML = '';
  faqAdminList.innerHTML = '';

  tickets.filter(t => t.status === 'open').forEach(t => {
    const div = document.createElement('div');
    div.style.marginBottom = '10px';
    div.innerHTML = `<strong>${t.department}</strong>: ${t.message} <small>${new Date(t.timestamp).toLocaleString()}</small>`;
    ticketsList.appendChild(div);
  });

  const userCount = Object.keys(registeredUsers).length;
  usersList.innerHTML = `<p>Total users: ${userCount}</p>`;

  faqs.forEach((faq, i) => {
    const div = document.createElement('div');
    div.style.marginBottom = '10px';
    div.innerHTML = `<strong>${faq.question}</strong><br>${faq.answer} <small>(${faq.department})</small> <button onclick="deleteFAQ(${i})" style="margin-left:10px; background:#f44336; color:white; border:none; border-radius:3px; padding:2px 5px;">Delete</button>`;
    faqAdminList.appendChild(div);
  });
}

function addFAQ() {
  const question = document.getElementById('faqQuestion').value;
  const answer = document.getElementById('faqAnswer').value;
  const department = document.getElementById('faqDepartment').value;
  if (!question || !answer) return;
  faqs.push({ question, answer, department });
  localStorage.setItem('faqs', JSON.stringify(faqs));
  document.getElementById('faqQuestion').value = '';
  document.getElementById('faqAnswer').value = '';
  showAdminPanel();
  renderFAQs();
}

function deleteFAQ(index) {
  faqs.splice(index, 1);
  localStorage.setItem('faqs', JSON.stringify(faqs));
  showAdminPanel();
  renderFAQs();
}

// Notifications
function showNotification(message, duration = 3000) {
  const notif = document.getElementById('notification');
  notif.textContent = message;
  notif.style.display = 'block';
  setTimeout(() => {
    notif.style.display = 'none';
  }, duration);
  if (currentUser) {
    notifications.push({ user: currentUser.email, title: 'Notification', message, timestamp: new Date().toISOString() });
    localStorage.setItem('notifications', JSON.stringify(notifications));
  }
}

// Event listeners
document.getElementById('chatInput').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') sendChatMessage();
});
// Update the script section in home_page.html with this:

// Data storage (now handled by backend)
let currentUsers = null;

// Initialize
window.onload = function() {
    checkSession();
    loadFAQs();
};

// Check if user is logged in
// Replace the checkSession function with this:
function checkSession() {
    fetch('auth.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'action=check_session'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.user) {
            currentUser = data.user;
            updateUI();
            // Load admin panel if admin
            if (currentUser.isAdmin) {
                showAdminPanel();
            }
        }
    })
    .catch(error => console.error('Error:', error));
}

// Update the showAdminPanel function:
function showAdminPanel() {
    if (!currentUser || !currentUser.isAdmin) {
        console.log("Not admin or not logged in");
        return;
    }

    // Load tickets
    fetch('tickets.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'action=get_tickets&status=open'
    })
    .then(response => response.json())
    .then(data => {
        const ticketsList = document.getElementById('ticketsList');
        ticketsList.innerHTML = '';
        
        if (data.success && data.tickets) {
            data.tickets.forEach(t => {
                const div = document.createElement('div');
                div.style.marginBottom = '10px';
                div.style.padding = '10px';
                div.style.border = '1px solid #ddd';
                div.style.borderRadius = '5px';
                div.innerHTML = `
                    <strong>${t.department}</strong><br>
                    <p>${t.message}</p>
                    <small>From: ${t.user_name}</small><br>
                    <small>${new Date(t.created_at).toLocaleString()}</small>
                    <button onclick="resolveTicket(${t.id})" style="float:right; background:#4CAF50; color:white; border:none; padding:5px 10px; border-radius:3px;">Resolve</button>
                `;
                ticketsList.appendChild(div);
            });
        } else {
            ticketsList.innerHTML = '<p>No open tickets found</p>';
        }
    })
    .catch(error => console.error('Error:', error));

    // Load user stats
    fetch('admin.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'action=get_user_stats'
    })
    .then(response => response.json())
    .then(data => {
        const usersList = document.getElementById('usersList');
        if (data.success) {
            usersList.innerHTML = `
                <p>Total Users: ${data.total_users}</p>
                <p>Active Today: ${data.active_today}</p>
            `;
        }
    })
    .catch(error => console.error('Error:', error));

    // Load FAQs for management
    loadFAQsForAdmin();
}

// Add this new function for admin FAQ management
function loadFAQsForAdmin() {
    fetch('faqs.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'action=get_faqs'
    })
    .then(response => response.json())
    .then(data => {
        const faqAdminList = document.getElementById('faqAdminList');
        faqAdminList.innerHTML = '';
        
        if (data.success && data.faqs) {
            data.faqs.forEach((faq, index) => {
                const div = document.createElement('div');
                div.style.marginBottom = '10px';
                div.style.padding = '10px';
                div.style.border = '1px solid #ddd';
                div.style.borderRadius = '5px';
                div.innerHTML = `
                    <strong>Q: ${faq.question}</strong><br>
                    <p>A: ${faq.answer}</p>
                    <small>Department: ${faq.department}</small>
                    <button onclick="deleteFAQ(${faq.id})" style="float:right; background:#f44336; color:white; border:none; padding:5px 10px; border-radius:3px;">Delete</button>
                `;
                faqAdminList.appendChild(div);
            });
        }
    })
    .catch(error => console.error('Error:', error));
}

// Add this new function to resolve tickets
function resolveTicket(ticketId) {
    fetch('tickets.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `action=resolve_ticket&ticket_id=${ticketId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Ticket resolved successfully');
            showAdminPanel(); // Refresh the admin panel
        } else {
            showNotification(data.message);
        }
    })
    .catch(error => console.error('Error:', error));
}

// Update UI based on login status
function updateUI() {
    if (currentUser) {
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('registerBtn').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'inline-block';
        document.getElementById('profileBtn').style.display = 'inline-block';
        if (currentUser.isAdmin) {
            document.getElementById('adminBtn').style.display = 'inline-block';
        }
    } else {
        document.getElementById('loginBtn').style.display = 'inline-block';
        document.getElementById('registerBtn').style.display = 'inline-block';
        document.getElementById('logoutBtn').style.display = 'none';
        document.getElementById('profileBtn').style.display = 'none';
        document.getElementById('adminBtn').style.display = 'none';
    }
}

// Load FAQs
function loadFAQs() {
    fetch('faqs.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'action=get_faqs'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const faqList = document.getElementById('faqList');
            faqList.innerHTML = '';
            data.faqs.forEach(faq => {
                const div = document.createElement('div');
                div.style.marginBottom = '10px';
                div.innerHTML = `<strong>${faq.question}</strong><br>${faq.answer} <small>(${faq.department})</small>`;
                faqList.appendChild(div);
            });
        }
    })
    .catch(error => console.error('Error:', error));
}

// Auth functions
function submitRegister() {
    const name = document.getElementById('regName').value;
    const email = document.getElementById('regEmail').value;
    const pass = document.getElementById('regPassword').value;

    if (name && email && pass) {
        fetch('auth.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `action=register&name=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}&password=${encodeURIComponent(pass)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('registerSuccess').style.display = 'block';
                document.getElementById('regName').value = '';
                document.getElementById('regEmail').value = '';
                document.getElementById('regPassword').value = '';
                setTimeout(() => {
                    toggleRegisterModal();
                    toggleLoginModal();
                    document.getElementById('loginMessage').style.display = 'block';
                }, 1000);
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('loginError').textContent = data.message;
            }
        })
        .catch(error => console.error('Error:', error));
    }
}

function submitLogin() {
    const email = document.getElementById('loginEmail').value;
    const pass = document.getElementById('loginPassword').value;

    document.getElementById('loginMessage').style.display = 'none';
    document.getElementById('loginError').style.display = 'none';

    if (email && pass) {
        fetch('auth.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `action=login&email=${encodeURIComponent(email)}&password=${encodeURIComponent(pass)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('loginSuccess').style.display = 'block';
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                currentUser = data.user;
                setTimeout(() => {
                    toggleLoginModal();
                    updateUI();
                }, 1000);
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('loginError').textContent = data.message;
            }
        })
        // In your login success handler:
.then(data => {
    if (data.success) {
        console.log("Login response data:", data);
        currentUser = data.user;
        console.log("Admin status:", currentUser.isAdmin, typeof currentUser.isAdmin);
        updateUI();
    }
})
        .catch(error => console.error('Error:', error));
    }
}

function logout() {
    fetch('auth.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'action=logout'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentUser = null;
            updateUI();
            showNotification("Logged out successfully");
        }
    })
    .catch(error => console.error('Error:', error));
}

// Document functions
function downloadDoc(type) {
    const docId = type === 'bonafide' ? 1 : 2;
    
    fetch('documents.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `action=download_document&document_id=${docId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Create a temporary link to trigger download
            const link = document.createElement('a');
            link.href = data.file_path;
            link.download = data.file_name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`Downloading ${type} certificate...`);
        } else {
            showNotification(data.message);
        }
    })
    .catch(error => console.error('Error:', error));
}

function submitDocRequest() {
    const type = document.getElementById('docType').value;
    const reason = document.getElementById('docReason').value;
    const docId = type === 'bonafide' ? 1 : 2;
    
    if (!reason) return;
    
    fetch('documents.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `action=request_document&document_id=${docId}&reason=${encodeURIComponent(reason)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Document request submitted.');
            toggleDocRequestModal();
        } else {
            showNotification(data.message);
        }
    })
    .catch(error => console.error('Error:', error));
}

// Ticket functions
function submitTicket() {
    const department = document.getElementById('ticketDepartment').value;
    const message = document.getElementById('ticketMessage').value;
    
    if (!department || !message) return;
    
    fetch('tickets.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `action=submit_ticket&department=${encodeURIComponent(department)}&message=${encodeURIComponent(message)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Ticket submitted. We will get back to you soon.');
            toggleTicketModal();
        } else {
            showNotification(data.message);
        }
    })
    .catch(error => console.error('Error:', error));
}

// Profile functions
function showProfile() {
    const profileInfo = document.getElementById('profileInfo');
    const notificationsDiv = document.getElementById('notifications');
    
    if (currentUser) {
        profileInfo.innerHTML = `<p><strong>Name:</strong> ${currentUser.name}</p><p><strong>Email:</strong> ${currentUser.email}</p>`;
        
        fetch('notifications.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'action=get_notifications'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                notificationsDiv.innerHTML = '';
                data.notifications.forEach(n => {
                    const div = document.createElement('div');
                    div.style.marginBottom = '10px';
                    div.innerHTML = `<strong>${n.title}</strong><br>${n.message} <small>${new Date(n.created_at).toLocaleString()}</small>`;
                    notificationsDiv.appendChild(div);
                });
            }
        })
        .catch(error => console.error('Error:', error));
    } else {
        profileInfo.innerHTML = 'Not logged in';
    }
}

// Admin functions
function showAdminPanel() {
    if (!currentUser || !currentUser.isAdmin) return;
    
    fetch('tickets.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'action=get_tickets&status=open'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const ticketsList = document.getElementById('ticketsList');
            ticketsList.innerHTML = '';
            data.tickets.forEach(t => {
                const div = document.createElement('div');
                div.style.marginBottom = '10px';
                div.innerHTML = `<strong>${t.department}</strong>: ${t.message} <small>${new Date(t.created_at).toLocaleString()}</small>`;
                ticketsList.appendChild(div);
            });
        }
    })
    .catch(error => console.error('Error:', error));
    
    fetch('notifications.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'action=get_notifications'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const notificationsDiv = document.getElementById('notifications');
            notificationsDiv.innerHTML = '';
            data.notifications.forEach(n => {
                const div = document.createElement('div');
                div.style.marginBottom = '10px';
                div.innerHTML = `<strong>${n.title}</strong><br>${n.message} <small>${new Date(n.created_at).toLocaleString()}</small>`;
                notificationsDiv.appendChild(div);
            });
        }
    })
    .catch(error => console.error('Error:', error));
}

function addFAQ() {
    const question = document.getElementById('faqQuestion').value;
    const answer = document.getElementById('faqAnswer').value;
    const department = document.getElementById('faqDepartment').value;
    
    if (!question || !answer) return;
    
    fetch('faqs.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `action=add_faq&question=${encodeURIComponent(question)}&answer=${encodeURIComponent(answer)}&department=${encodeURIComponent(department)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('faqQuestion').value = '';
            document.getElementById('faqAnswer').value = '';
            showAdminPanel();
            loadFAQs();
        } else {
            showNotification(data.message);
        }
    })
    .catch(error => console.error('Error:', error));
}

function deleteFAQ(index) {
    fetch('faqs.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `action=delete_faq&faq_id=${index}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAdminPanel();
            loadFAQs();
        } else {
            showNotification(data.message);
        }
    })
    .catch(error => console.error('Error:', error));
}

// Chatbot functions
function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message) return;

    const department = document.getElementById('departmentSelect').value;
    addChatMessage(message, 'user', department);

    // Simulate typing
    const typing = document.createElement('span');
    typing.className = 'typing';
    document.getElementById('chatLog').appendChild(typing);
    
    fetch('chat.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `action=send_message&message=${encodeURIComponent(message)}&department=${encodeURIComponent(department)}`
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('chatLog').removeChild(typing);
        if (data.success) {
            addChatMessage(data.answer, 'bot', department);
            // Ask for feedback
            setTimeout(() => {
                addChatMessage("Was this answer helpful? (Yes/No)", 'bot', department);
            }, 1000);
        }
    })
    .catch(error => {
        document.getElementById('chatLog').removeChild(typing);
        console.error('Error:', error);
    });
    
    input.value = '';
}

function addChatMessage(text, sender, department) {
    const chatLog = document.getElementById('chatLog');
    const msg = document.createElement('div');
    msg.className = `chat-message ${sender}-message`;
    const time = new Date().toLocaleTimeString();
    msg.innerHTML = `<div>${text}</div><div class="timestamp">${time}${department ? ' ‚Ä¢ ' + department : ''}</div>`;
    chatLog.appendChild(msg);
    chatLog.scrollTop = chatLog.scrollHeight;
}

// Notification
function showNotification(message, duration = 3000) {
    const notif = document.getElementById('notification');
    notif.textContent = message;
    notif.style.display = 'block';
    setTimeout(() => {
        notif.style.display = 'none';
    }, duration);
}

// Event listeners
document.getElementById('chatInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') sendChatMessage();
});
</script>
</body>
</html>
